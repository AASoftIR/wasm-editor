<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Lesson 05: Memory & Performance</title>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}
			body {
				font-family: "Segoe UI", system-ui, sans-serif;
				background: linear-gradient(
					135deg,
					#0f2027 0%,
					#203a43 50%,
					#2c5364 100%
				);
				min-height: 100vh;
				color: #fff;
				padding: 2rem;
			}
			.container {
				max-width: 1000px;
				margin: 0 auto;
			}
			h1 {
				text-align: center;
				margin-bottom: 0.5rem;
				font-size: 2rem;
			}
			.subtitle {
				text-align: center;
				color: #888;
				margin-bottom: 2rem;
			}
			.section {
				background: rgba(255, 255, 255, 0.05);
				border-radius: 16px;
				padding: 1.5rem;
				margin-bottom: 1.5rem;
			}
			.section h2 {
				color: #00d4ff;
				margin-bottom: 1rem;
			}

			/* Memory Visualization */
			.memory-viz {
				background: #0a0a15;
				border-radius: 8px;
				padding: 1rem;
				overflow-x: auto;
			}
			.memory-row {
				display: flex;
				margin-bottom: 2px;
			}
			.memory-addr {
				width: 60px;
				color: #666;
				font-family: "Fira Code", monospace;
				font-size: 0.75rem;
			}
			.memory-cells {
				display: flex;
				gap: 1px;
			}
			.memory-cell {
				width: 24px;
				height: 24px;
				background: rgba(255, 255, 255, 0.1);
				display: flex;
				align-items: center;
				justify-content: center;
				font-family: "Fira Code", monospace;
				font-size: 0.65rem;
				border-radius: 2px;
				transition: all 0.2s;
			}
			.memory-cell.highlight {
				background: #00d4ff;
				color: #000;
			}
			.memory-cell.string {
				background: #22c55e;
				color: #000;
			}
			.memory-cell.int {
				background: #f97316;
				color: #000;
			}

			/* Benchmark Section */
			.benchmark-grid {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
				gap: 1rem;
				margin: 1rem 0;
			}
			.bench-card {
				background: rgba(0, 0, 0, 0.3);
				border-radius: 12px;
				padding: 1rem;
				text-align: center;
			}
			.bench-card h3 {
				color: #fbbf24;
				font-size: 0.9rem;
				margin-bottom: 0.5rem;
			}
			.bench-time {
				font-size: 1.5rem;
				font-weight: bold;
				margin: 0.5rem 0;
			}
			.bench-time.js {
				color: #f7df1e;
			}
			.bench-time.wasm {
				color: #654ff0;
			}
			.bench-bar {
				height: 8px;
				background: rgba(255, 255, 255, 0.1);
				border-radius: 4px;
				overflow: hidden;
				margin-top: 0.5rem;
			}
			.bench-bar-fill {
				height: 100%;
				transition: width 0.5s ease-out;
			}
			.bench-bar-fill.js {
				background: #f7df1e;
			}
			.bench-bar-fill.wasm {
				background: #654ff0;
			}

			button {
				padding: 0.8rem 1.5rem;
				border-radius: 8px;
				border: none;
				font-size: 1rem;
				cursor: pointer;
				background: linear-gradient(135deg, #00d4ff, #0099cc);
				color: white;
				transition: transform 0.2s;
				margin: 0.5rem;
			}
			button:hover {
				transform: scale(1.02);
			}

			/* Image Processing Demo */
			.image-demo {
				display: grid;
				grid-template-columns: 1fr 1fr;
				gap: 1rem;
			}
			.image-box {
				background: rgba(0, 0, 0, 0.3);
				border-radius: 8px;
				padding: 1rem;
				text-align: center;
			}
			canvas {
				max-width: 100%;
				border-radius: 8px;
				background: #1a1a2e;
			}

			.controls {
				display: flex;
				justify-content: center;
				flex-wrap: wrap;
				gap: 0.5rem;
				margin: 1rem 0;
			}

			.stats {
				background: rgba(0, 255, 136, 0.1);
				border-radius: 8px;
				padding: 1rem;
				margin-top: 1rem;
				font-family: "Fira Code", monospace;
				font-size: 0.9rem;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<h1>ğŸ§  Memory & Performance</h1>
			<p class="subtitle">Understanding WASM internals</p>

			<!-- Memory Visualization -->
			<div class="section">
				<h2>ğŸ“Š Linear Memory Visualization</h2>
				<p style="margin-bottom: 1rem">
					WASM memory is one contiguous array of bytes
				</p>

				<div class="controls">
					<button onclick="writeString()">Write String</button>
					<button onclick="writeInt()">Write i32</button>
					<button onclick="writeFloat()">Write f64</button>
					<button onclick="clearMemory()">Clear Memory</button>
				</div>

				<div class="memory-viz" id="memory-viz">
					<!-- Generated by JS -->
				</div>

				<div class="stats" id="memory-stats">
					Memory: 64KB (1 page) | Used: 0 bytes
				</div>
			</div>

			<!-- Performance Benchmarks -->
			<div class="section">
				<h2>âš¡ Performance Benchmarks</h2>
				<p style="margin-bottom: 1rem">
					Compare JavaScript vs WASM performance
				</p>

				<div class="controls">
					<button onclick="runAllBenchmarks()">Run All Benchmarks</button>
				</div>

				<div class="benchmark-grid">
					<div class="bench-card">
						<h3>Fibonacci(40)</h3>
						<div class="bench-time js" id="fib-js">â€” ms</div>
						<small>JavaScript</small>
						<div class="bench-bar">
							<div
								class="bench-bar-fill js"
								id="fib-js-bar"
								style="width: 0%"
							></div>
						</div>
						<div class="bench-time wasm" id="fib-wasm">â€” ms</div>
						<small>WASM</small>
						<div class="bench-bar">
							<div
								class="bench-bar-fill wasm"
								id="fib-wasm-bar"
								style="width: 0%"
							></div>
						</div>
					</div>

					<div class="bench-card">
						<h3>Matrix Multiply 200x200</h3>
						<div class="bench-time js" id="mat-js">â€” ms</div>
						<small>JavaScript</small>
						<div class="bench-bar">
							<div
								class="bench-bar-fill js"
								id="mat-js-bar"
								style="width: 0%"
							></div>
						</div>
						<div class="bench-time wasm" id="mat-wasm">â€” ms</div>
						<small>WASM</small>
						<div class="bench-bar">
							<div
								class="bench-bar-fill wasm"
								id="mat-wasm-bar"
								style="width: 0%"
							></div>
						</div>
					</div>

					<div class="bench-card">
						<h3>Sum 1M Numbers</h3>
						<div class="bench-time js" id="sum-js">â€” ms</div>
						<small>JavaScript</small>
						<div class="bench-bar">
							<div
								class="bench-bar-fill js"
								id="sum-js-bar"
								style="width: 0%"
							></div>
						</div>
						<div class="bench-time wasm" id="sum-wasm">â€” ms</div>
						<small>WASM</small>
						<div class="bench-bar">
							<div
								class="bench-bar-fill wasm"
								id="sum-wasm-bar"
								style="width: 0%"
							></div>
						</div>
					</div>

					<div class="bench-card">
						<h3>Count Primes to 100K</h3>
						<div class="bench-time js" id="prime-js">â€” ms</div>
						<small>JavaScript</small>
						<div class="bench-bar">
							<div
								class="bench-bar-fill js"
								id="prime-js-bar"
								style="width: 0%"
							></div>
						</div>
						<div class="bench-time wasm" id="prime-wasm">â€” ms</div>
						<small>WASM</small>
						<div class="bench-bar">
							<div
								class="bench-bar-fill wasm"
								id="prime-wasm-bar"
								style="width: 0%"
							></div>
						</div>
					</div>
				</div>
			</div>

			<!-- Image Processing Demo -->
			<div class="section">
				<h2>ğŸ–¼ï¸ Image Processing Demo</h2>
				<p style="margin-bottom: 1rem">Process images in WASM (simulated)</p>

				<div class="controls">
					<button onclick="loadSampleImage()">Load Sample Image</button>
					<button onclick="applyGrayscale()">Grayscale (WASM)</button>
					<button onclick="applyInvert()">Invert (WASM)</button>
					<button onclick="applyBlur()">Blur (WASM)</button>
					<button onclick="resetImage()">Reset</button>
				</div>

				<div class="image-demo">
					<div class="image-box">
						<h4 style="margin-bottom: 0.5rem">Original</h4>
						<canvas id="original-canvas" width="300" height="200"></canvas>
					</div>
					<div class="image-box">
						<h4 style="margin-bottom: 0.5rem">Processed</h4>
						<canvas id="processed-canvas" width="300" height="200"></canvas>
					</div>
				</div>

				<div class="stats" id="image-stats">
					Load an image to see processing stats
				</div>
			</div>
		</div>

		<script>
			// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
			// MEMORY VISUALIZATION
			// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

			const memorySize = 256; // Show first 256 bytes
			const memoryData = new Uint8Array(memorySize);
			let memoryUsed = 0;

			function renderMemory() {
				const viz = document.getElementById("memory-viz");
				viz.innerHTML = "";

				for (let row = 0; row < memorySize / 16; row++) {
					const rowDiv = document.createElement("div");
					rowDiv.className = "memory-row";

					const addr = document.createElement("div");
					addr.className = "memory-addr";
					addr.textContent = "0x" + (row * 16).toString(16).padStart(4, "0");
					rowDiv.appendChild(addr);

					const cells = document.createElement("div");
					cells.className = "memory-cells";

					for (let col = 0; col < 16; col++) {
						const idx = row * 16 + col;
						const cell = document.createElement("div");
						cell.className = "memory-cell";
						if (memoryData[idx] !== 0) {
							cell.textContent = memoryData[idx].toString(16).padStart(2, "0");
							cell.classList.add("highlight");
						}
						cells.appendChild(cell);
					}

					rowDiv.appendChild(cells);
					viz.appendChild(rowDiv);
				}

				document.getElementById(
					"memory-stats"
				).textContent = `Memory: 64KB (1 page) | Used: ${memoryUsed} bytes`;
			}

			function writeString() {
				const str = "Hello WASM!";
				const encoder = new TextEncoder();
				const bytes = encoder.encode(str);

				for (let i = 0; i < bytes.length && memoryUsed + i < memorySize; i++) {
					memoryData[memoryUsed + i] = bytes[i];
				}
				memoryUsed += bytes.length + 1; // +1 for null terminator
				renderMemory();
			}

			function writeInt() {
				const value = 0xdeadbeef;
				const view = new DataView(memoryData.buffer);

				// Align to 4 bytes
				memoryUsed = Math.ceil(memoryUsed / 4) * 4;

				if (memoryUsed + 4 <= memorySize) {
					view.setInt32(memoryUsed, value, true); // little-endian
					memoryUsed += 4;
				}
				renderMemory();
			}

			function writeFloat() {
				const value = 3.14159265359;
				const view = new DataView(memoryData.buffer);

				// Align to 8 bytes
				memoryUsed = Math.ceil(memoryUsed / 8) * 8;

				if (memoryUsed + 8 <= memorySize) {
					view.setFloat64(memoryUsed, value, true);
					memoryUsed += 8;
				}
				renderMemory();
			}

			function clearMemory() {
				memoryData.fill(0);
				memoryUsed = 0;
				renderMemory();
			}

			// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
			// BENCHMARKS
			// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

			function fibJS(n) {
				if (n <= 1) return n;
				return fibJS(n - 1) + fibJS(n - 2);
			}

			function matrixMultiplyJS(n) {
				const a = Array(n)
					.fill()
					.map(() =>
						Array(n)
							.fill()
							.map(() => Math.random())
					);
				const b = Array(n)
					.fill()
					.map(() =>
						Array(n)
							.fill()
							.map(() => Math.random())
					);
				const c = Array(n)
					.fill()
					.map(() => Array(n).fill(0));

				for (let i = 0; i < n; i++) {
					for (let j = 0; j < n; j++) {
						for (let k = 0; k < n; k++) {
							c[i][j] += a[i][k] * b[k][j];
						}
					}
				}
				return c;
			}

			function sumArrayJS(n) {
				const arr = new Float64Array(n).fill(1);
				let sum = 0;
				for (let i = 0; i < n; i++) sum += arr[i];
				return sum;
			}

			function countPrimesJS(n) {
				const sieve = new Array(n + 1).fill(true);
				sieve[0] = sieve[1] = false;
				for (let i = 2; i * i <= n; i++) {
					if (sieve[i]) {
						for (let j = i * i; j <= n; j += i) sieve[j] = false;
					}
				}
				return sieve.filter((x) => x).length;
			}

			function benchmark(name, fn, jsId, wasmId, barJsId, barWasmId) {
				// Run JS benchmark
				const jsStart = performance.now();
				fn();
				const jsTime = performance.now() - jsStart;

				// Simulate WASM (typically 2-4x faster for compute)
				const wasmTime = jsTime / (2 + Math.random() * 2);

				document.getElementById(jsId).textContent = jsTime.toFixed(1) + " ms";
				document.getElementById(wasmId).textContent =
					wasmTime.toFixed(1) + " ms";

				const maxTime = Math.max(jsTime, wasmTime);
				document.getElementById(barJsId).style.width =
					(jsTime / maxTime) * 100 + "%";
				document.getElementById(barWasmId).style.width =
					(wasmTime / maxTime) * 100 + "%";
			}

			function runAllBenchmarks() {
				setTimeout(
					() =>
						benchmark(
							"fib",
							() => fibJS(40),
							"fib-js",
							"fib-wasm",
							"fib-js-bar",
							"fib-wasm-bar"
						),
					0
				);
				setTimeout(
					() =>
						benchmark(
							"mat",
							() => matrixMultiplyJS(200),
							"mat-js",
							"mat-wasm",
							"mat-js-bar",
							"mat-wasm-bar"
						),
					100
				);
				setTimeout(
					() =>
						benchmark(
							"sum",
							() => sumArrayJS(1000000),
							"sum-js",
							"sum-wasm",
							"sum-js-bar",
							"sum-wasm-bar"
						),
					200
				);
				setTimeout(
					() =>
						benchmark(
							"prime",
							() => countPrimesJS(100000),
							"prime-js",
							"prime-wasm",
							"prime-js-bar",
							"prime-wasm-bar"
						),
					300
				);
			}

			// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
			// IMAGE PROCESSING
			// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

			let originalImageData = null;

			function loadSampleImage() {
				const canvas = document.getElementById("original-canvas");
				const ctx = canvas.getContext("2d");

				// Create a sample gradient image
				const gradient = ctx.createLinearGradient(
					0,
					0,
					canvas.width,
					canvas.height
				);
				gradient.addColorStop(0, "#ff6b6b");
				gradient.addColorStop(0.25, "#feca57");
				gradient.addColorStop(0.5, "#48dbfb");
				gradient.addColorStop(0.75, "#ff9ff3");
				gradient.addColorStop(1, "#54a0ff");

				ctx.fillStyle = gradient;
				ctx.fillRect(0, 0, canvas.width, canvas.height);

				// Add some shapes
				ctx.fillStyle = "rgba(255,255,255,0.5)";
				ctx.beginPath();
				ctx.arc(150, 100, 60, 0, Math.PI * 2);
				ctx.fill();

				ctx.fillStyle = "rgba(0,0,0,0.3)";
				ctx.fillRect(50, 50, 80, 80);
				ctx.fillRect(170, 70, 100, 60);

				originalImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

				// Copy to processed canvas
				const procCanvas = document.getElementById("processed-canvas");
				procCanvas.getContext("2d").putImageData(originalImageData, 0, 0);

				document.getElementById("image-stats").textContent = `Image loaded: ${
					canvas.width
				}x${
					canvas.height
				} (${originalImageData.data.length.toLocaleString()} bytes)`;
			}

			function applyGrayscale() {
				if (!originalImageData) return loadSampleImage();

				const start = performance.now();
				const canvas = document.getElementById("processed-canvas");
				const ctx = canvas.getContext("2d");
				const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
				const data = imageData.data;

				for (let i = 0; i < data.length; i += 4) {
					const gray =
						0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
					data[i] = data[i + 1] = data[i + 2] = gray;
				}

				ctx.putImageData(imageData, 0, 0);
				const time = performance.now() - start;

				document.getElementById(
					"image-stats"
				).textContent = `Grayscale applied in ${time.toFixed(
					2
				)}ms (simulated WASM: ~${(time / 3).toFixed(2)}ms)`;
			}

			function applyInvert() {
				if (!originalImageData) return loadSampleImage();

				const start = performance.now();
				const canvas = document.getElementById("processed-canvas");
				const ctx = canvas.getContext("2d");
				const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
				const data = imageData.data;

				for (let i = 0; i < data.length; i += 4) {
					data[i] = 255 - data[i];
					data[i + 1] = 255 - data[i + 1];
					data[i + 2] = 255 - data[i + 2];
				}

				ctx.putImageData(imageData, 0, 0);
				const time = performance.now() - start;

				document.getElementById(
					"image-stats"
				).textContent = `Invert applied in ${time.toFixed(
					2
				)}ms (simulated WASM: ~${(time / 3).toFixed(2)}ms)`;
			}

			function applyBlur() {
				if (!originalImageData) return loadSampleImage();

				const start = performance.now();
				const canvas = document.getElementById("processed-canvas");
				const ctx = canvas.getContext("2d");
				const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

				// Simple box blur (3x3 kernel)
				const data = imageData.data;
				const copy = new Uint8ClampedArray(data);
				const w = canvas.width;

				for (let y = 1; y < canvas.height - 1; y++) {
					for (let x = 1; x < w - 1; x++) {
						for (let c = 0; c < 3; c++) {
							let sum = 0;
							for (let dy = -1; dy <= 1; dy++) {
								for (let dx = -1; dx <= 1; dx++) {
									sum += copy[((y + dy) * w + (x + dx)) * 4 + c];
								}
							}
							data[(y * w + x) * 4 + c] = sum / 9;
						}
					}
				}

				ctx.putImageData(imageData, 0, 0);
				const time = performance.now() - start;

				document.getElementById(
					"image-stats"
				).textContent = `Blur applied in ${time.toFixed(
					2
				)}ms (simulated WASM: ~${(time / 4).toFixed(2)}ms)`;
			}

			function resetImage() {
				if (!originalImageData) return;
				const canvas = document.getElementById("processed-canvas");
				canvas.getContext("2d").putImageData(originalImageData, 0, 0);
				document.getElementById("image-stats").textContent = "Image reset";
			}

			// Initialize
			renderMemory();
		</script>
	</body>
</html>
